-- Script de calcul pour extraire le nombre d'exploitations agricole depuis les table nommées "exploitants_{year}_SUPVitre" 
-- transmise par le territoire et fournie par la draaf 53


-- travail des chiffres globaux à l'échelle du territoire 
-- (partie à reprendre si l'on veut travailler sur les chiffres concernant la répartition du type de strucutres)
-- En premier lieu on ajoute pour chacune des tables un champs nous donnant l'année 
-- 2015


-- table des parcelles avec id_pacage
-- On veut isoler les pacage de chaque années et réaliser un full-join afin d'obtenir ceux qui restent
--, ceux qui arrivent et ceux qui partent

drop table if exists "F5_AGR_EvolutionExploitationsAgricoles".parcelles_exploitants_2015_id_geom;
create table "F5_AGR_EvolutionExploitationsAgricoles".parcelles_exploitants_2015_id_geom as(
select p.id,st_intersection(tt.geom,p.geom) geom,tt.id_geom,pacage,num_ilot,num_parcel,code_cultu,surf_adm,"precision",semence,culture_d1,culture_d2,bio,engagement,maraichage,agroforest,dep_ilot 
from public."TerritoryTable_PV_BDTopo_2020.08_full_2154" tt 
left join "F5_AGR_EvolutionExploitationsAgricoles".parcelles_exploitants_2015 p 
on st_intersects(p.geom,tt.geom)
where tt.rank=1
);

drop table if exists "F5_AGR_EvolutionExploitationsAgricoles".parcelles_exploitants_2016_id_geom;
create table "F5_AGR_EvolutionExploitationsAgricoles".parcelles_exploitants_2016_id_geom as(
select p.id,st_intersection(tt.geom,p.geom) geom,tt.id_geom,pacage,num_ilot,num_parcel,code_cultu,surf_adm,"precision",semence,culture_d1,culture_d2,bio,engagement,maraichage,agroforest,dep_ilot 
from public."TerritoryTable_PV_BDTopo_2020.08_full_2154" tt 
left join "F5_AGR_EvolutionExploitationsAgricoles".parcelles_exploitants_2016 p 
on st_intersects(p.geom,tt.geom)
where tt.rank=1
);

drop table if exists "F5_AGR_EvolutionExploitationsAgricoles".parcelles_exploitants_2017_id_geom;
create table "F5_AGR_EvolutionExploitationsAgricoles".parcelles_exploitants_2017_id_geom as(
select p.id,st_intersection(tt.geom,p.geom) geom,tt.id_geom,pacage,num_ilot,num_parcel,code_cultu,surf_adm,"precision",semence,culture_d1,culture_d2,bio,engagement,maraichage,agroforest,dep_ilot 
from public."TerritoryTable_PV_BDTopo_2020.08_full_2154" tt 
left join "F5_AGR_EvolutionExploitationsAgricoles".parcelles_exploitants_2017 p 
on st_intersects(p.geom,tt.geom)
where tt.rank=1
);


drop table if exists "F5_AGR_EvolutionExploitationsAgricoles".parcelles_exploitants_2018_id_geom;
create table "F5_AGR_EvolutionExploitationsAgricoles".parcelles_exploitants_2018_id_geom as(
select p.id,st_intersection(tt.geom,p.geom) geom,tt.id_geom,pacage,num_ilot,num_parcel,code_cultu,surf_adm,"precision",semence,culture_d1,culture_d2,bio,engagement,maraichage,agroforest,dep_ilot 
from public."TerritoryTable_PV_BDTopo_2020.08_full_2154" tt 
left join "F5_AGR_EvolutionExploitationsAgricoles".parcelles_exploitants_2018 p 
on st_intersects(p.geom,tt.geom)
where tt.rank=1
);

drop table if exists "F5_AGR_EvolutionExploitationsAgricoles".parcelles_exploitants_2019_id_geom;
create table "F5_AGR_EvolutionExploitationsAgricoles".parcelles_exploitants_2019_id_geom as(
select p.id,st_intersection(tt.geom,p.geom) geom,tt.id_geom,pacage,num_ilot,num_parcel,code_cultu,surf_adm,"precision",semence,culture_d1,culture_d2,bio,engagement,maraichage,agroforest--,dep_ilot 
from public."TerritoryTable_PV_BDTopo_2020.08_full_2154" tt 
left join "F5_AGR_EvolutionExploitationsAgricoles".parcelles_exploitants_2019 p 
on st_intersects(p.geom,tt.geom)
where tt.rank=1
);

drop table if exists "F5_AGR_EvolutionExploitationsAgricoles".parcelles_exploitants_2020_id_geom;
create table "F5_AGR_EvolutionExploitationsAgricoles".parcelles_exploitants_2020_id_geom as(
select p.id,st_intersection(tt.geom,p.geom) geom,tt.id_geom,pacage,num_ilot,num_parcel,code_cultu,surf_adm,"precision",semence,culture_d1,culture_d2,bio,engagement,maraichage,agroforest 
from public."TerritoryTable_PV_BDTopo_2020.08_full_2154" tt 
left join "F5_AGR_EvolutionExploitationsAgricoles".parcelles_exploitants_2020 p 
on st_intersects(p.geom,tt.geom)
where tt.rank=1
);


--//--//--//--//--//--//--//--//--//--//--//
-- CALCUL DES STOCKs par AN ainsi que les fluxs i/o --
--//--//--//--//--//--//--//--//--//--//--//

-- t pour table et s pour synthèse

	
---//////---- Les calculs à des échelles infra-scot ne peuvent pas fonctionner, on compte des parcelles appartenant à une même exploitation 
		-- mais elles peuvent être dans plusieurs communes, on les compte alors plusieurs fois (double compte)
		-- On part donc sur un calcul à l'échelle du SCoT. On compte une exploitation dès lors qu'elle possède une parcelle sur le territoire 

-- On compte d'une part les stocks par années et d'autres part les fluxs à partir de la présence ou non des id_pacage d'une année à l'autre
-- (null en année n mais true en n+1 = apparition)
-- (true en année n mais null en n+1 = disparition)

drop table if exists "F5_AGR_EvolutionExploitationsAgricoles"."F5_AGR_EvolutionExploitationsAgricoles";
create table "F5_AGR_EvolutionExploitationsAgricoles"."F5_AGR_EvolutionExploitationsAgricoles" as (
with t1516 as (
		select  p15.pacage pacage15,p16.pacage pacage16 from "F5_AGR_EvolutionExploitationsAgricoles".parcelles_exploitants_2015 p15 full join "F5_AGR_EvolutionExploitationsAgricoles".parcelles_exploitants_2016 p16 on p15.pacage = p16.pacage 
		),
	t1617 as(
		select p16.pacage pacage16,p17.pacage pacage17 from "F5_AGR_EvolutionExploitationsAgricoles".parcelles_exploitants_2016 p16 full join "F5_AGR_EvolutionExploitationsAgricoles".parcelles_exploitants_2017 p17 on p16.pacage = p17.pacage 
		),
	t1718 as(
		select p17.pacage pacage17,p18.pacage pacage18 from "F5_AGR_EvolutionExploitationsAgricoles".parcelles_exploitants_2017 p17 full join "F5_AGR_EvolutionExploitationsAgricoles".parcelles_exploitants_2018 p18 on p17.pacage = p18.pacage
	),
	t1819 as(
		select p18.pacage pacage18,p19.pacage pacage19 from "F5_AGR_EvolutionExploitationsAgricoles".parcelles_exploitants_2018 p18 full join "F5_AGR_EvolutionExploitationsAgricoles".parcelles_exploitants_2019 p19 on p18.pacage = p19.pacage
),
t1920 as(
		select p19.pacage pacage19,p20.pacage pacage20 from "F5_AGR_EvolutionExploitationsAgricoles".parcelles_exploitants_2019 p19 full join "F5_AGR_EvolutionExploitationsAgricoles".parcelles_exploitants_2020 p20 on p19.pacage = p20.pacage
)
,
		s1516 as(
			with s1516stock as(
			-- stock total 2015
			select  count(distinct(pacage15)) stock15 from t1516 
			),
			-- flux négatif
			s1516neg as(
			select   count(distinct(pacage15)) neg1516 from t1516
			where pacage16 is null
			
			),
			s1516pos as(
			select   count(distinct(pacage16)) pos1516 from t1516
			where pacage15 is null
			
			)
				select t1.stock15,t2.neg1516, t3.pos1516 from s1516stock t1
				cross join s1516neg t2
				cross join s1516pos t3
				)
--				select * from s1516
				,
		s1617 as(
			with s1617stock as(
			-- stock total 2016
			select count(distinct(pacage16)) stock16 from t1617 
			),
			-- flux négatif
			s1617neg as(
			select  count(distinct(pacage16)) neg1617 from t1617
			where pacage17 is null
			
			),
			s1617pos as(
			select   count(distinct(pacage17)) pos1617 from t1617
			where pacage16 is null
			
			)
				select t1.stock16 , t2.neg1617 , t3.pos1617 
				from s1617stock t1
				cross join s1617neg t2
				cross join s1617pos t3	
			),
		s1718 as(
			with s1718stock as(
			-- stock total 2017
			select count(distinct(pacage17)) stock17 from t1718 
			),
			-- flux négatif
			s1718neg as(
			select   count(distinct(pacage17)) neg1718 from t1718
			where pacage18 is null
			
			),
			s1718pos as(
			select  count(distinct(pacage18)) pos1718 from t1718
			where pacage17 is null
			
			)
				
				select t1.stock17,t2.neg1718, t3.pos1718 from s1718stock t1
				cross join s1718neg t2
				cross join s1718pos t3
				
		),
		s1819 as(
			with s1819stock as(
			-- stock total 2018
			select  count(distinct(pacage18)) stock18 from t1819 
			),
			-- flux négatif
			s1819neg as(
			select   count(distinct(pacage18)) neg1819 from t1819
			where pacage19 is null
			
			),
			s1819pos as(
			select  count(distinct(pacage19)) pos1819 from t1819
			where pacage18 is null
			
			)
				
				select t1.stock18,t2.neg1819, t3.pos1819 from s1819stock t1
				cross join s1819neg t2
				cross join s1819pos t3
		),
		s19 as(
			-- stock total 2019
			select  count(distinct(pacage19)) stock19 from t1920
			),
		s1920 as(
			with s1920stock as(
			-- stock total 2018
			select  count(distinct(pacage19)) stock19 from t1920
			),
			-- flux négatif
			s1920neg as(
			select   count(distinct(pacage19)) neg1920 from t1920
			where pacage20 is null
			
			),
			s1920pos as(
			select  count(distinct(pacage20)) pos1920 from t1920
			where pacage19 is null
			
			)
				
				select t1.stock19,t2.neg1920, t3.pos1920 from s1920stock t1
				cross join s1920neg t2
				cross join s1920pos t3
		),
		s20 as(
			-- stock total 2020
			select  count(distinct(pacage20)) stock20 from t1920
			)
			

select '2015' as year, stock15 stock, '0' as neg, '0' as pos
	from s1516 t1
union all 
select  '2016' as year, stock16 stock, neg1516 neg, pos1516 pos
	from  s1516, s1617
union all
select  '2017' as year, stock17 stock, neg1617 neg , pos1617 pos
	from s1617 t3 ,s1718
union all
select  '2018' as year, stock18 stock, neg1718 neg , pos1718 pos
	from s1718 t4, s1819
union all
select  '2019' as year, stock19 stock, neg1819 neg , pos1819 pos
	from s1819 t5, s19
union all
select  '2020' as year, stock20 stock, neg1920 neg , pos1920 pos
	from s1920 t6, s20
)
